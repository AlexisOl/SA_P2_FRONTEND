 <p-toast />
    <p-confirmDialog />

    <div class="card">
      <!-- Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="margin: 0;">{{ isEdit() ? 'Editar' : 'Nueva' }} película</h2>
        <div style="display: flex; gap: 0.5rem;">
          <p-button label="Guardar" icon="pi pi-save" (onClick)="save()" />
          <p-button
            label="Regresar"
            icon="pi pi-arrow-left"
            severity="secondary"
            (onClick)="back()"
          />
        </div>
      </div>

      <!-- Tabs -->
      <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
        <p-button
          label="Datos"
          [severity]="activeTab === 'datos' ? 'primary' : 'secondary'"
          (onClick)="activeTab = 'datos'"
        />
        <p-button
          label="Categorías"
          [severity]="activeTab === 'categorias' ? 'primary' : 'secondary'"
          (onClick)="activeTab = 'categorias'"
        />
        <p-button
          label="Pósters"
          [severity]="activeTab === 'posters' ? 'primary' : 'secondary'"
          (onClick)="activeTab = 'posters'"
        />
      </div>

      <!-- TAB DATOS -->
      <div *ngIf="activeTab === 'datos'">
        <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem;">
          
          <!-- Título -->
          <div style="grid-column: span 12 / span 12;">
            @media (min-width: 768px) { & { grid-column: span 6 / span 6; } }
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Título *</label>
            <input pInputText name="titulo" [(ngModel)]="form.titulo" />
            <small style="color: #ef4444; display: block; margin-top: 0.25rem;" *ngIf="submitted && !form.titulo">
              El título es requerido
            </small>
          </div>

          <!-- Duración -->
          <div style="grid-column: span 12 / span 12;">
            @media (min-width: 768px) { & { grid-column: span 3 / span 3; } }
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Duración (min) *</label>
            <p-inputNumber name="duracion" [(ngModel)]="form.duracion" [min]="1" [max]="500" />
            <small style="color: #ef4444; display: block; margin-top: 0.25rem;" *ngIf="submitted && !form.duracion">
              Requerido
            </small>
          </div>

          <!-- Clasificación -->
          <div style="grid-column: span 12 / span 12;">
            @media (min-width: 768px) { & { grid-column: span 3 / span 3; } }
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Clasificación *</label>
            <p-select
              name="clasificacion"
              [(ngModel)]="form.clasificacion"
              [options]="clasificaciones"
              optionLabel="label"
              optionValue="value"
              placeholder="Seleccione"
            />
            <small style="color: #ef4444; display: block; margin-top: 0.25rem;" *ngIf="submitted && !form.clasificacion">
              Requerido
            </small>
          </div>

          <!-- Fecha de estreno -->
          <div style="grid-column: span 12 / span 12;">
            @media (min-width: 768px) { & { grid-column: span 4 / span 4; } }
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Fecha de estreno *</label>
            <p-datepicker
              name="fechaEstreno"
              [(ngModel)]="fechaEstrenoDate"
              dateFormat="yy-mm-dd"
              [showIcon]="true"
            />
            <small style="color: #ef4444; display: block; margin-top: 0.25rem;" *ngIf="submitted && !fechaEstrenoDate">
              Requerido
            </small>
          </div>

          <!-- Director -->
          <div style="grid-column: span 12 / span 12;">
            @media (min-width: 768px) { & { grid-column: span 4 / span 4; } }
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Director</label>
            <input pInputText name="director" [(ngModel)]="form.director" />
          </div>

          <!-- Checkbox Activa -->
          <div style="grid-column: span 12 / span 12; display: flex; align-items: center; padding-top: 2rem;">
            @media (min-width: 768px) { & { grid-column: span 4 / span 4; } }
            <p-checkbox
              name="activa"
              [(ngModel)]="form.activa"
              [binary]="true"
              inputId="activa"
            />
            <label for="activa" style="margin-left: 0.5rem; font-weight: 600; cursor: pointer;">Película activa</label>
          </div>

          <!-- Sinopsis -->
          <div style="grid-column: span 12 / span 12;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Sinopsis *</label>
            <textarea pTextarea name="sinopsis" rows="4" [(ngModel)]="form.sinopsis"></textarea>
            <small style="color: #ef4444; display: block; margin-top: 0.25rem;" *ngIf="submitted && !form.sinopsis">
              La sinopsis es requerida
            </small>
          </div>

          <!-- Reparto (Cast) -->
          <div style="grid-column: span 12 / span 12;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Reparto (cast)</label>
            
            <!-- Tags del cast existente -->
            <div class="cast-tag-container" *ngIf="castArr.length > 0" style="margin-bottom: 1rem;">
              <div *ngFor="let actor of castArr; let i = index" class="cast-item">
                <p-tag [value]="actor" severity="secondary" />
                <p-button
                  icon="pi pi-times"
                  [rounded]="true"
                  [text]="true"
                  severity="danger"
                  size="small"
                  (onClick)="removeCast(i)"
                />
              </div>
            </div>

            <!-- Input para agregar nuevo -->
            <div style="display: flex; gap: 0.5rem;">
              <input
                pInputText
                name="castInput"
                [(ngModel)]="castInput"
                placeholder="Escribe un nombre y presiona Enter o coma"
                (keydown.enter)="addCastFromKey($event)"
                (keydown)="onCastComma($event)"
                (blur)="addCastFromBlur()"
                style="flex: 1;"
              />
              <p-button
                label="Añadir"
                icon="pi pi-plus"
                (onClick)="addCastFromButton()"
                [disabled]="!castInput?.trim()"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- TAB CATEGORÍAS -->
      <div *ngIf="activeTab === 'categorias'">
        <ng-container *ngIf="isEdit(); else needSaveFirst">
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <p-select
              name="categoriaSeleccionada"
              [(ngModel)]="categoriaSeleccionada"
              [options]="categorias()"
              optionLabel="nombre"
              optionValue="id"
              placeholder="Selecciona una categoría"
              [style]="{'min-width': '250px'}"
            />
            <p-button
              label="Agregar"
              icon="pi pi-plus"
              (onClick)="addCategory()"
              [disabled]="!categoriaSeleccionada"
            />
          </div>

          <p-table
            [value]="categoriasPelicula()"
            dataKey="id"
            [tableStyle]="{ 'min-width': '40rem' }"
          >
            <ng-template pTemplate="header">
              <tr>
                <th>Nombre</th>
                <th>Estado</th>
                <th style="width:8rem"></th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-cat>
              <tr>
                <td>{{ cat.nombre }}</td>
                <td>
                  <p-tag
                    [value]="cat.activa ? 'ACTIVA' : 'INACTIVA'"
                    [severity]="cat.activa ? 'success' : 'danger'"
                  />
                </td>
                <td style="text-align: right;">
                  <p-button
                    icon="pi pi-trash"
                    severity="danger"
                    [text]="true"
                    (onClick)="removeCategory(cat.categoriaId)"
                  />
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="3" style="text-align: center; padding: 2rem;">
                  Sin categorías asignadas
                </td>
              </tr>
            </ng-template>
          </p-table>
        </ng-container>
      </div>

      <!-- TAB PÓSTERS -->
      <div *ngIf="activeTab === 'posters'">
        <ng-container *ngIf="isEdit(); else needSaveFirst">
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: flex-end;">
            <p-fileUpload
              mode="basic"
              name="file"
              chooseLabel="Seleccionar imagen"
              (onSelect)="onFileSelected($event)"
              [auto]="false"
              [customUpload]="true"
              (uploadHandler)="onUpload()"
              [maxFileSize]="5242880"
            />
            <p-inputNumber
              name="posterOrden"
              [(ngModel)]="posterOrden"
              [min]="1"
              [max]="3"
              placeholder="Orden (1-3)"
              [style]="{'width': '120px'}"
            />
            <p-button
              label="Subir"
              icon="pi pi-upload"
              (onClick)="triggerUpload()"
              [disabled]="!fileToUpload"
            />
          </div>

          <p-table
            [value]="posters()"
            dataKey="id"
            [tableStyle]="{ 'min-width': '40rem' }"
          >
            <ng-template pTemplate="header">
              <tr>
                <th>Vista</th>
                <th>URL</th>
                <th>Orden</th>
                <th>Estado</th>
                <th style="width:12rem"></th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-p>
              <tr>
                <td>
                  <img
                    [src]="p.url"
                    alt="poster"
                    width="48"
                    style="border-radius: 4px;"
                  />
                </td>
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                  {{ p.url }}
                </td>
                <td>{{ p.orden }}</td>
                <td>
                  <p-tag
                    [value]="p.activa ? 'ACTIVO' : 'INACTIVO'"
                    [severity]="p.activa ? 'success' : 'danger'"
                  />
                </td>
                <td style="text-align: right;">
                  <p-button
                    [label]="p.activa ? 'Desactivar' : 'Activar'"
                    [icon]="p.activa ? 'pi pi-ban' : 'pi pi-check'"
                    [text]="true"
                    (onClick)="togglePoster(p)"
                  />
                  <p-button
                    icon="pi pi-trash"
                    severity="danger"
                    [text]="true"
                    (onClick)="deletePoster(p)"
                  />
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="5" style="text-align: center; padding: 2rem;">Sin pósters</td>
              </tr>
            </ng-template>
          </p-table>
        </ng-container>
      </div>

      <ng-template #needSaveFirst>
        <p-tag
          severity="info"
          value="Guarda primero la película para gestionar categorías y pósters."
        />
      </ng-template>
    </div>