<div class="container mx-auto p-4 lg:p-6">
      <h2 class="text-2xl font-bold mb-2">Reporte: 5 salas m√°s gustadas</h2>
      <p class="text-color-secondary mb-4">
        El ranking se calcula por promedio de puntuaci√≥n (1‚Äì5) dentro del rango
        seleccionado. Puedes filtrar por una sala espec√≠fica.
      </p>

      <!-- FILTROS -->
      <!-- FILTROS -->
      <div class="card p-4 mb-4 toolbar">
        <!-- Fila de fechas -->
        <div class="flex gap-3 mb-3 flex-wrap">
          <div class="flex-1" style="min-width: 200px; max-width: 300px;">
            <label class="font-semibold block mb-2">Desde *</label>
            <p-datepicker
              [(ngModel)]="filtros.desde"
              [showIcon]="true"
              class="w-full"
              dateFormat="dd/mm/yy"
            />
          </div>

          <div class="flex-1" style="min-width: 200px; max-width: 300px;">
            <label class="font-semibold block mb-2">Hasta *</label>
            <p-datepicker
              [(ngModel)]="filtros.hasta"
              [showIcon]="true"
              class="w-full"
              dateFormat="dd/mm/yy"
            />
          </div>
        </div>

        <!-- Fila de sala -->
        <div class="mb-3" style="max-width: 517px;">
          <label class="font-semibold block mb-2">Sala (opcional)</label>
          <p-select
            class="w-full"
            [options]="salas"
            optionLabel="nombre"
            optionValue="id"
            placeholder="Todas"
            [(ngModel)]="filtros.salaId"
          >
          </p-select>
        </div>

        <!-- Botones centrados -->
        <div class="flex justify-content-center gap-2">
          <p-button
            label="Generar"
            icon="pi pi-search"
            (onClick)="generar()"
            [loading]="loading"
          />
          <p-button
            label="Limpiar"
            icon="pi pi-eraser"
            severity="secondary"
            (onClick)="limpiar()"
            [disabled]="loading"
          />
          <p-button
            label="PDF"
            icon="pi pi-file-pdf"
            severity="danger"
            (onClick)="generarPDF()"
            [disabled]="!rows().length || loading"
          />
        </div>
      </div>

      <p-divider></p-divider>

      <!-- TABLA TOP 5 -->
      <p-table
        [value]="rows()"
        dataKey="salaId"
        [expandedRowKeys]="expandedRowKeys"
        (onRowExpand)="onRowExpand($event)"
        (onRowCollapse)="onRowCollapse($event)"
        [paginator]="true"
        [rows]="5"
        [rowsPerPageOptions]="[5]"
        [responsiveLayout]="'scroll'"
      >
        <!-- HEADER -->
        <ng-template pTemplate="header">
          <tr>
            <th style="width:3rem"></th>
            <th pSortableColumn="salaNombre">
              Sala <p-sortIcon field="salaNombre"></p-sortIcon>
            </th>
            <th pSortableColumn="promedio">
              Promedio <p-sortIcon field="promedio"></p-sortIcon>
            </th>
            <th pSortableColumn="total">
              Total calificaciones <p-sortIcon field="total"></p-sortIcon>
            </th>
          </tr>
        </ng-template>

        <!-- BODY -->
        <ng-template pTemplate="body" let-row>
          <tr>
            <td>
              <button
                pButton
                type="button"
                class="p-button-text p-button-rounded"
                [icon]="
                  expandedRowKeys[row.salaId]
                    ? 'pi pi-chevron-down'
                    : 'pi pi-chevron-right'
                "
                (click)="toggleRow(row)"
              ></button>
            </td>
            <td class="font-medium">{{ row.salaNombre }}</td>
            <td>
              <p-rating
                [readonly]="true"
                [ngModel]="row.promedio"
                [stars]="5"
              ></p-rating>
              <span class="ml-2">{{ row.promedio | number: '1.2-2' }}</span>
            </td>
            <td>{{ row.total }}</td>
          </tr>

          <!-- üîΩ EXPANSI√ìN EN LA MISMA FILA (compatible con v17) -->
          <tr *ngIf="expandedRowKeys[row.salaId]">
            <td [attr.colspan]="4">
              <div class="p-3 bg-surface-100 rounded-md mt-2">
                <h4 class="m-0 mb-3">
                  Calificaciones ({{ row.calificaciones?.length || 0 }})
                </h4>

                <p-table
                  [value]="row.calificaciones || []"
                  [paginator]="true"
                  [rows]="5"
                  [rowsPerPageOptions]="[5, 10]"
                  [responsiveLayout]="'scroll'"
                >
                  <ng-template pTemplate="header">
                    <tr>
                      <th style="min-width: 10rem">Fecha</th>
                      <th style="min-width: 12rem">Usuario</th>
                      <th style="min-width: 10rem">Puntuaci√≥n</th>
                      <th>Comentario</th>
                    </tr>
                  </ng-template>

                  <ng-template pTemplate="body" let-c>
                    <tr>
                      <td class="nowrap">
                        {{ c.fecha | date: 'dd/MM/yyyy HH:mm' }}
                      </td>
                      <td>{{ c.usuarioId }}</td>
                      <td class="nowrap">
                        <p-rating
                          [readonly]="true"
                          [ngModel]="c.puntuacion"
                          [stars]="5"
                        ></p-rating>
                        <span class="ml-2">{{ c.puntuacion }}</span>
                      </td>
                      <td style="white-space: pre-wrap">
                        {{ c.comentario || '‚Äî' }}
                      </td>
                    </tr>
                  </ng-template>

                  <ng-template pTemplate="emptymessage">
                    <tr>
                      <td colspan="4" class="text-center text-color-secondary">
                        Sin calificaciones para este rango.
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="4" class="text-center text-color-secondary">
              No hay datos.
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <p-toast />